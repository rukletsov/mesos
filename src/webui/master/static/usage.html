<html>
<head>
<!-- Load c3.css -->
<link href="/static/c3/c3.css" rel="stylesheet" type="text/css">
<script src="/static/d3/d3.min.js" charset="utf-8"></script>
<script src="/static/c3/c3.min.js"></script>
<link href="/static/css/bootstrap-3.0.3.min.css" rel="stylesheet">
</head>
<body>
<h1>Mesos Resource Accounting</h1>
<div class="btn-group" role="group" aria-label="...">
  <button type="button" class="btn btn-default" id="btn-accumulated">Accumulated</button>
  <button type="button" class="btn btn-default" id="btn-snapshot">Snapshot</button>
</div>
<div id="chart"></div>
<table class="table table-striped">
<thead>
<th>
Framework id
</th>
<th>
CPU/hr
</th>
<th>
Mem/hr
</th>
</thead>
<tbody id="stats_table">
</tbody>
</table>
<script>
var g_accumulate = false

var loc = "/master/usage.json"

var chart = 0

function load() {
  d3.json(loc, function(data) {
    var frameworkTypes = []
    var group = []
    var columns = []

    var runningSum = {}
    var currentSum = {}
    var timestamps = []

    for (index = 0; index < data["usage"].length; ++index) {
      var samples = data["usage"][index]["frameworks"]

      timestamp = data["usage"][index]["timestamp"]
      timestamps.push(timestamp)

      for (var framework_id in samples) {
        sample = samples[framework_id]
        frameworkTypes[framework_id] = 'area'

        if (runningSum[framework_id] == undefined) {
          runningSum[framework_id] = []
          currentSum[framework_id] = 0
          group.push(framework_id)
        }

        if (g_accumulate) {
          currentSum[framework_id] += parseFloat(sample.cpus)
        } else {
          currentSum[framework_id] = parseFloat(sample.cpus)
        }
        runningSum[framework_id][timestamp] = currentSum[framework_id]
      }
    }

    console.log(runningSum)

    for (index = 0; index < group.length; ++index) {
      framework_id = group[index]
      row = [framework_id]
      last_sum = 0

      for (var timestampIndex in timestamps) {
        timestamp = timestamps[timestampIndex]
        if (runningSum[framework_id][timestamp] == undefined) {
          // TODO(nnielsen): Don't push 0 if we know running sum.
          row.push(last_sum)
        } else {
          row.push(runningSum[framework_id][timestamp])
          last_sum = runningSum[framework_id][timestamp]
        }
      }

      columns.push(row)
    }

    // 2014-12-11 23:59:23.007659008+00:00

    console.log(columns)

    chart = c3.generate({
      bindto: '#chart',
      data: {
        columns: columns,
        types: frameworkTypes,
        groups: [group]
      },
      axis: {
        y: {
            label: 'CPU/seconds'
        }
    }
    });

    // var stats = document.createElement("p");
    // var node = document.createTextNode("This is new.");

    // para.appendChild(node);
    // var stats_table = document.getElementById("stats_table");
    // stats_table.appendChild(stats);

  });
}

load()
var stop = setInterval(load, 10000)

var btnaccumulated = document.getElementById("btn-accumulated")
btnaccumulated.onclick = function(){
  g_accumulate = true
  load()
}

var btnsnapshot = document.getElementById("btn-snapshot")
btnsnapshot.onclick = function(){
  g_accumulate = false
  load()
}

</script>
</body>
</html>
